name: Extract Domains and Push to GitHub

on:
  schedule:
    - cron: '0 7,15 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 15:00 23:00 æ‰§è¡Œ
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® SSH å¯†é’¥
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git remote set-url origin git@github.com:Mercury000/extract-domain.git
          git fetch

      - name: ä¸‹è½½ adrules.list æ–‡ä»¶
        run: |
          curl -s -o adrules.list https://raw.githubusercontent.com/Cats-Team/AdRules/main/adrules.list

      - name: ç”Ÿæˆå½“å‰æ–‡ä»¶çš„ MD5 å€¼
        id: generate_md5
        run: |
          ADRULES_MD5=$(md5sum adrules.list | awk '{print $1}')
          echo "ADRULES_MD5=$ADRULES_MD5" >> $GITHUB_ENV
          echo "MD5å€¼å·²ç”Ÿæˆ: $ADRULES_MD5"

      - name: åŠ è½½æˆ–åˆ›å»º md5_hashes.txt
        id: load_or_create_md5
        run: |
          if [ -f md5_hashes.txt ]; then
            source md5_hashes.txt
            echo "PREVIOUS_ADRULES_MD5=$ADRULES_MD5" >> $GITHUB_ENV
            echo "âœ… å·²åŠ è½½ä¸Šä¸€æ¬¡ä¿å­˜çš„ MD5 å€¼ã€‚"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° md5_hashes.txtï¼Œæ­£åœ¨åˆ›å»ºæ–°çš„å“ˆå¸Œè®°å½•æ–‡ä»¶..."
            echo "ADRULES_MD5=$ADRULES_MD5" > md5_hashes.txt
            # é¦–æ¬¡è¿è¡Œæ—¶å°† PREVIOUS è®¾ä¸ºç©ºå€¼ä»¥ç¡®ä¿è§¦å‘æ›´æ–°
            echo "PREVIOUS_ADRULES_MD5=" >> $GITHUB_ENV
            echo "ğŸ†• å·²åˆ›å»ºåˆå§‹ md5_hashes.txt æ–‡ä»¶"
          fi

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        id: check_update
        run: |
          if [ ! -f md5_hashes.txt ] || [ -z "$PREVIOUS_ADRULES_MD5" ] || [ "$ADRULES_MD5" != "$PREVIOUS_ADRULES_MD5" ]; then
            echo "ğŸ”„ éœ€è¦æ›´æ–°ï¼šé¦–æ¬¡è¿è¡Œæˆ–æ–‡ä»¶å†…å®¹å·²å˜åŒ–"
            echo "NEED_UPDATE=true" >> $GITHUB_ENV
          else
            echo "âœ… æ–‡ä»¶æœªå˜åŒ–ï¼Œè·³è¿‡åç»­æ­¥éª¤"
            exit 0
          fi

      - name: å¼ºåˆ¶åˆ›å»ºæˆ–æ›´æ–° MD5 æ–‡ä»¶
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "ğŸ’¾ æ­£åœ¨æ›´æ–° md5_hashes.txt..."
          echo "ADRULES_MD5=$ADRULES_MD5" > md5_hashes.txt
          echo "å½“å‰MD5å€¼: $(cat md5_hashes.txt)"

      - name: æå–åŸŸåå¹¶ä¿å­˜ä¸º domains.txt
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "å¼€å§‹æå–åŸŸå..."
          : > domains.txt
          grep -E '^(DOMAIN-SUFFIX|DOMAIN),' adrules.list | awk -F, '{print $2}' | sort -u > domains.txt
          echo "å…±æå– $(wc -l < domains.txt) ä¸ªå”¯ä¸€åŸŸå"

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "=== æ–‡ä»¶å˜æ›´çŠ¶æ€ ==="
          git status --porcelain
          echo "==================="

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: env.NEED_UPDATE == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: "domains.txt md5_hashes.txt"
          commit_message: "æ›´æ–°ï¼š$(date '+%Y-%m-%d %H:%M') çš„åŸŸååˆ—è¡¨å’ŒMD5æ ¡éªŒ"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"