name: Extract Domains from AdRules

on:
  schedule:
    # 每天凌晨1点执行一次
    - cron: '0 1 * * *'
  # 也可通过手动触发工作流
  workflow_dispatch:

jobs:
  extract-domains:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download and process AdRules list
      run: |
        # 下载原始规则列表
        curl -sL https://raw.githubusercontent.com/Cats-Team/AdRules/main/adrules.list > adrules.tmp

        # 仅保留以"||"开头的行，并去除"domain-suffix"部分，提取域名
        grep -E '^\|\|' adrules.tmp | sed -E 's/^|\|\|([^|]+)\|domain-suffix([^|]*)$/\1/' > domains.txt

        # 显示提取的域名数量
        wc -l domains.txt

    - name: Upload domains list as artifact
      uses: actions/upload-artifact@v3
      with:
        name: domains-list
        path: domains.txt

    - name: Commit and push changes
      run: |
        # 检查是否有更改
        if git diff --quiet; then
          echo "No changes to commit"
        else
          # 添加、提交并推送更改
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add domains.txt
          git commit -m "Update domains list"
          git push
        fi
