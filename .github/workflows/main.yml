name: Extract Domains and Push to GitHub

on:
  schedule:
    - cron: '0 7,15 * * *'   # 每天北京时间 15:00 23:00 执行
  workflow_dispatch:        # 支持手动运行

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 设置 SSH 密钥
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: 配置 Git 用户信息
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git remote set-url origin git@github.com:Mercury000/extract-domain.git
          git fetch

      - name: 下载 adrules.list 文件
        run: |
          curl -s -o adrules.list https://raw.githubusercontent.com/Cats-Team/AdRules/main/adrules.list

      - name: 生成当前文件的 MD5 值
        id: generate_md5
        run: |
          ADRULES_MD5=$(md5sum adrules.list | awk '{print $1}')
          echo "ADRULES_MD5=$ADRULES_MD5" >> $GITHUB_ENV
          echo "MD5值已生成: $ADRULES_MD5"

      - name: 加载或创建 md5_hashes.txt
        id: load_or_create_md5
        run: |
          if [ -f md5_hashes.txt ]; then
            source md5_hashes.txt
            echo "PREVIOUS_ADRULES_MD5=$ADRULES_MD5" >> $GITHUB_ENV
            echo "✅ 已加载上一次保存的 MD5 值。"
          else
            echo "⚠️ 未找到 md5_hashes.txt，正在创建新的哈希记录文件..."
            echo "ADRULES_MD5=$ADRULES_MD5" > md5_hashes.txt
            # 首次运行时将 PREVIOUS 设为空值以确保触发更新
            echo "PREVIOUS_ADRULES_MD5=" >> $GITHUB_ENV
            echo "🆕 已创建初始 md5_hashes.txt 文件"
          fi

      - name: 判断是否需要更新
        id: check_update
        run: |
          if [ ! -f md5_hashes.txt ] || [ -z "$PREVIOUS_ADRULES_MD5" ] || [ "$ADRULES_MD5" != "$PREVIOUS_ADRULES_MD5" ]; then
            echo "🔄 需要更新：首次运行或文件内容已变化"
            echo "NEED_UPDATE=true" >> $GITHUB_ENV
          else
            echo "✅ 文件未变化，跳过后续步骤"
            exit 0
          fi

      - name: 强制创建或更新 MD5 文件
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "💾 正在更新 md5_hashes.txt..."
          echo "ADRULES_MD5=$ADRULES_MD5" > md5_hashes.txt
          echo "当前MD5值: $(cat md5_hashes.txt)"

      - name: 提取域名并保存为 domains.txt
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "开始提取域名..."
          : > domains.txt
          grep -E '^(DOMAIN-SUFFIX|DOMAIN),' adrules.list | awk -F, '{print $2}' | sort -u > domains.txt
          echo "共提取 $(wc -l < domains.txt) 个唯一域名"

      - name: 检查文件变更
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "=== 文件变更状态 ==="
          git status --porcelain
          echo "==================="

      - name: 提交并推送更改
        if: env.NEED_UPDATE == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: "domains.txt md5_hashes.txt"
          commit_message: "更新：$(date '+%Y-%m-%d %H:%M') 的域名列表和MD5校验"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"