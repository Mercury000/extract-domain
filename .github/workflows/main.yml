name: Extract and Push Domains via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  extract-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v2

    - name: Download adrules.list from Cats-Team
      run: |
        curl -o adrules.list https://raw.githubusercontent.com/Cats-Team/AdRules/main/adrules.list

    - name: Extract domains
      run: |
        grep -oP '(?<=DOMAIN-SUFFIX,).+' adrules.list > domains.txt

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # Add GitHub to known_hosts to prevent interactive prompt
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Set up Git config
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Commit and push via SSH
      run: |
        git add domains.txt
        git commit -m "Add extracted domains via SSH"
        git push git@github.com:Mercury000/extract-domain.git HEAD:main
